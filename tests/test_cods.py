#!/usr/bin/python
# -*- coding: utf-8 -*-
"""
Unit tests for cods.

"""
from os.path import join

import pytest
from hdx.data.vocabulary import Vocabulary
from hdx.hdx_configuration import Configuration
from hdx.hdx_locations import Locations
from hdx.location.country import Country

from cods import get_datasets_metadata, generate_dataset


alljson = [{'DatasetTitle': 'Philippines - Subnational Administrative Boundaries', 'DatasetDescription': 'Philippines administrative levels:\r\n\r\n(0)  Country\r\n\r\n(1)  Region (Filipino: rehiyon)\r\n\r\n(2)  Provinces (Filipino:  lalawigan, probinsiya) and independent cities (Filipino:  lungsod, siyudad/ciudad, dakbayan, lakanbalen)\r\n\r\n(3)  Municipalities (Filipino:  bayan, balen, bungto, banwa, ili) and component cities (Filipino:  lungsod, siyudad/ciudad, dakbayan, dakbanwa, lakanbalen)\r\n\r\nThe original datasets were derived from the boundaries of the Barangays as observed at the end of April 2016 as per the Philippine Geographic Standard Code (PSGC) dataset. It has been generated on the basis of the layer created by the Philippine Statistics Authority (PSA) in the context of the 2015 population census.  \r\n\r\nVetting and live service provision by [Information Technology Outreach Services (ITOS)](https://cviog.uga.edu/international-center/) with funding from USAID.\r\n\r\nOCHA acknowledges PSA and the National Mapping and Resource Information Authority (NAMRIA) as the sources.  LMB is the source of official administrative boundaries of the Philippines. In the absence of available official administrative boundary, the IMTWG have agreed to clean and use the PSA administrative boundaries which are used to facilitate data collection of surveys and censuses. The dataset can only be considered as indicative boundaries and not official.\r\n\r\nFor administrative level 4 (Barangay) please contact the contributor (OCHA Philippines) via this page.\r\n\r\nThese shapefiles are suitable for database or ArcGIS joins to the sex and age disaggregated population statistics found on HDX [here](https://data.humdata.org/dataset/philippines-2015-census-population-administrative-level-1-to-4).', 'FrequencyUpdates': '365', 'Resources': [{'Format': 'XLSX', 'ResourceItemTitle': 'Philippines - Subnational Administrative Boundaries', 'ResourceItemDescription': 'Philippines - Subnational Administrative Boundaries', 'DownloadURL': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/80e52e31-d06c-47ab-9bfa-cbb57dc17a1e/download/phl_adminboundaries_tabulardata.xlsx', 'Version': 'Latest', 'Valid_From_Date': '2020-07-30T09:59:36', 'Valid_To_Date': '1900-01-01T00:00:00'}, {'Format': 'ZIPPED SHAPEFILES', 'ResourceItemTitle': 'Philippines - Subnational Administrative Boundaries', 'ResourceItemDescription': 'Philippines - Subnational Administrative Boundaries', 'DownloadURL': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/12457689-6a86-4474-8032-5ca9464d38a8/download/phl_adm_psa_namria_20200529_shp.zip', 'Version': 'Latest', 'Valid_From_Date': '2020-07-30T09:59:36', 'Valid_To_Date': '1900-01-01T00:00:00'}, {'Format': 'EMF', 'ResourceItemTitle': 'Philippines - Subnational Administrative Boundaries', 'ResourceItemDescription': 'Philippines - Subnational Administrative Boundaries', 'DownloadURL': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/82cda4bf-19f1-47bf-9469-f8bb8e5446d3/download/phl_adm_psa_namria_20200529_emf.zip', 'Version': 'Latest', 'Valid_From_Date': '2020-07-30T09:59:36', 'Valid_To_Date': '1900-01-01T00:00:00'}, {'Format': 'KMZ', 'ResourceItemTitle': 'Philippines - Subnational Administrative Boundaries', 'ResourceItemDescription': 'Philippines - Subnational Administrative Boundaries', 'DownloadURL': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/fab322bb-07f1-4f45-9980-795d9294386b/download/phl_adm_psa_namria_20200529_kmz.zip', 'Version': 'Latest', 'Valid_From_Date': '2020-07-30T09:59:36', 'Valid_To_Date': '1900-01-01T00:00:00'}, {'Format': 'ZIPPED GEODATABASE', 'ResourceItemTitle': 'Philippines - Subnational Administrative Boundaries', 'ResourceItemDescription': 'Philippines - Subnational Administrative Boundaries', 'DownloadURL': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/c8fd86b6-eac2-4e7d-8ee3-6f0d01b991da/download/phl_adminboundaries_candidate_adm3.gdb.zip', 'Version': 'Latest', 'Valid_From_Date': '2020-07-30T09:59:36', 'Valid_To_Date': '1900-01-01T00:00:00'}, {'Format': 'LIVE SERVICE', 'ResourceItemTitle': 'Philippines - Subnational Administrative Boundaries', 'ResourceItemDescription': 'Philippines - Subnational Administrative Boundaries', 'DownloadURL': 'https://gistmaps.itos.uga.edu/arcgis/rest/services/V00_0/PHL_pcode/MapServer', 'Version': '1', 'Valid_From_Date': '2020-07-30T09:59:36', 'Valid_To_Date': '1900-01-01T00:00:00'}, {'Format': 'PDF', 'ResourceItemTitle': 'Philippines - Subnational Administrative Boundaries', 'ResourceItemDescription': 'Philippines - Subnational Administrative Boundaries', 'DownloadURL': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/7c56c053-00f9-4eb7-ad61-6d07a954fc2b/download/phl-cod-ab-2020_06_05.pdf', 'Version': 'Latest', 'Valid_From_Date': '2020-07-30T09:59:36', 'Valid_To_Date': '1900-01-01T00:00:00'}], 'Source': 'National Mapping and Resource Information Authority (NAMRIA), Philippines Statistics Authority (PSA)', 'Contributor': 'OCHA Philippines', 'DatasetDate': '2018-02-09T00:00:00', 'Location': ['phl'], 'Visibility': 'True', 'License': 'Other: Humanitarian use only', 'Methodology': 'Census: ', 'Caveats': 'Prepared by OCHA\r\n\r\nThe two administrative level 2 features that were previously represented as comprising the ‘Negros Island Region’ administrative level 1 features [then coded PH1800000000] have been restored to administrative level 1 features PH060000000 and PH070000000. (Negros Island Region officially existed only from 29 May 2015 to 9 August 2017.) This adjustment has been propagated to administrative levels 2 and 3.\r\n\r\nDue to the complexity and extraordinarily large number of polygon features KMZ files have been generated but their quality cannot be verified.\r\nITOS have prepared three versions of the administrative 0 layer to assist mapping:\r\n• phl_admbnda_adm0_psa_namria_itos_20200529 with one part, as usual,\r\n• phl_admbnda_adm0_3part_psa_namria_20180130 with three multipart sections covering the North, middle and South portions of the country, and\r\n• phl_admbnda_adm0_singlepart_psa_namria_20180130 with all 3,656 polygons represented as separate features.', 'Tags': ['administrative divisions', 'common operational dataset - cod'], 'Total': 7}]


class TestCods():
    @pytest.fixture(scope='function')
    def configuration(self):
        Configuration._create(user_agent='test', hdx_key='12345',
                              project_config_yaml=join('tests', 'config', 'project_configuration.yml'))
        Locations.set_validlocations([{'name': 'phl', 'title': 'Philippines'}])
        Country.countriesdata(use_live=False)
        Vocabulary._tags_dict = True
        Vocabulary._approved_vocabulary = {'tags': [{'name': 'common operational dataset - cod'}, {'name': 'administrative divisions'}], 'id': '4e61d464-4943-4e97-973a-84673c1aaa87', 'name': 'approved'}

    @pytest.fixture(scope='function')
    def downloader(self):
        class Response:
            @staticmethod
            def json():
                pass

        class Download:
            @staticmethod
            def download(url):
                response = Response()

                def fn():
                    return alljson
                response.json = fn
                return response
        return Download()

    def test_get_datasets_metadata(self, downloader):
        datasets_metadata = get_datasets_metadata('http://lala', downloader)
        assert datasets_metadata == alljson

    def test_generate_dataset(self, configuration):
        dataset = generate_dataset(alljson[0])
        assert dataset == {'name': 'philippines-subnational-administrative-boundaries', 'title': 'Philippines - Subnational Administrative Boundaries',
                           'notes': 'Philippines - Subnational Administrative Boundaries  \nPhilippines administrative levels:\r\n\r\n(0)  Country\r\n\r\n(1)  Region (Filipino: rehiyon)\r\n\r\n(2)  Provinces (Filipino:  lalawigan, probinsiya) and independent cities (Filipino:  lungsod, siyudad/ciudad, dakbayan, lakanbalen)\r\n\r\n(3)  Municipalities (Filipino:  bayan, balen, bungto, banwa, ili) and component cities (Filipino:  lungsod, siyudad/ciudad, dakbayan, dakbanwa, lakanbalen)\r\n\r\nThe original datasets were derived from the boundaries of the Barangays as observed at the end of April 2016 as per the Philippine Geographic Standard Code (PSGC) dataset. It has been generated on the basis of the layer created by the Philippine Statistics Authority (PSA) in the context of the 2015 population census.  \r\n\r\nVetting and live service provision by [Information Technology Outreach Services (ITOS)](https://cviog.uga.edu/international-center/) with funding from USAID.\r\n\r\nOCHA acknowledges PSA and the National Mapping and Resource Information Authority (NAMRIA) as the sources.  LMB is the source of official administrative boundaries of the Philippines. In the absence of available official administrative boundary, the IMTWG have agreed to clean and use the PSA administrative boundaries which are used to facilitate data collection of surveys and censuses. The dataset can only be considered as indicative boundaries and not official.\r\n\r\nFor administrative level 4 (Barangay) please contact the contributor (OCHA Philippines) via this page.\r\n\r\nThese shapefiles are suitable for database or ArcGIS joins to the sex and age disaggregated population statistics found on HDX [here](https://data.humdata.org/dataset/philippines-2015-census-population-administrative-level-1-to-4).',
                           'dataset_source': 'National Mapping and Resource Information Authority (NAMRIA), Philippines Statistics Authority (PSA)',
                           'methodology': 'Other', 'methodology_other': 'Census: ', 'license_id': 'hdx-other',
                           'license_other': 'Licence: Other: Humanitarian use only',
                           'caveats': 'Prepared by OCHA\r\n\r\nThe two administrative level 2 features that were previously represented as comprising the ‘Negros Island Region’ administrative level 1 features [then coded PH1800000000] have been restored to administrative level 1 features PH060000000 and PH070000000. (Negros Island Region officially existed only from 29 May 2015 to 9 August 2017.) This adjustment has been propagated to administrative levels 2 and 3.\r\n\r\nDue to the complexity and extraordinarily large number of polygon features KMZ files have been generated but their quality cannot be verified.\r\nITOS have prepared three versions of the administrative 0 layer to assist mapping:\r\n• phl_admbnda_adm0_psa_namria_itos_20200529 with one part, as usual,\r\n• phl_admbnda_adm0_3part_psa_namria_20180130 with three multipart sections covering the North, middle and South portions of the country, and\r\n• phl_admbnda_adm0_singlepart_psa_namria_20180130 with all 3,656 polygons represented as separate features.',
                           'data_update_frequency': '365', 'cod_level': 'cod-enhanced', 'maintainer': '196196be-6037-4488-8b71-d786adf4c081',
                           'owner_org': '27fbd3ff-d0f4-4658-8a69-a07f49a7a853', 'subnational': '1', 'groups': [{'name': 'phl'}],
                           'tags': [{'name': 'administrative divisions', 'vocabulary_id': '4e61d464-4943-4e97-973a-84673c1aaa87'}, {'name': 'common operational dataset - cod', 'vocabulary_id': '4e61d464-4943-4e97-973a-84673c1aaa87'}],
                           'dataset_date': '[2018-02-09T00:00:00 TO 2018-02-09T00:00:00]'}
        resources = dataset.get_resources()
        assert len(resources) == alljson[0]['Total']
        assert resources == [{'name': 'Philippines - Subnational Administrative Boundaries', 'description': 'Philippines - Subnational Administrative Boundaries', 'url': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/80e52e31-d06c-47ab-9bfa-cbb57dc17a1e/download/phl_adminboundaries_tabulardata.xlsx', 'format': 'XLSX', 'grouping': 'Latest', 'daterange_for_data': '[2020-07-30T09:59:36 TO 1900-01-01T00:00:00]', 'resource_type': 'api', 'url_type': 'api'}, {'name': 'Philippines - Subnational Administrative Boundaries', 'description': 'Philippines - Subnational Administrative Boundaries', 'url': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/12457689-6a86-4474-8032-5ca9464d38a8/download/phl_adm_psa_namria_20200529_shp.zip', 'format': 'ZIPPED SHAPEFILES', 'grouping': 'Latest', 'daterange_for_data': '[2020-07-30T09:59:36 TO 1900-01-01T00:00:00]', 'resource_type': 'api', 'url_type': 'api'}, {'name': 'Philippines - Subnational Administrative Boundaries', 'description': 'Philippines - Subnational Administrative Boundaries', 'url': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/82cda4bf-19f1-47bf-9469-f8bb8e5446d3/download/phl_adm_psa_namria_20200529_emf.zip', 'format': 'EMF', 'grouping': 'Latest', 'daterange_for_data': '[2020-07-30T09:59:36 TO 1900-01-01T00:00:00]', 'resource_type': 'api', 'url_type': 'api'}, {'name': 'Philippines - Subnational Administrative Boundaries', 'description': 'Philippines - Subnational Administrative Boundaries', 'url': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/fab322bb-07f1-4f45-9980-795d9294386b/download/phl_adm_psa_namria_20200529_kmz.zip', 'format': 'KMZ', 'grouping': 'Latest', 'daterange_for_data': '[2020-07-30T09:59:36 TO 1900-01-01T00:00:00]', 'resource_type': 'api', 'url_type': 'api'}, {'name': 'Philippines - Subnational Administrative Boundaries', 'description': 'Philippines - Subnational Administrative Boundaries', 'url': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/c8fd86b6-eac2-4e7d-8ee3-6f0d01b991da/download/phl_adminboundaries_candidate_adm3.gdb.zip', 'format': 'ZIPPED GEODATABASE', 'grouping': 'Latest', 'daterange_for_data': '[2020-07-30T09:59:36 TO 1900-01-01T00:00:00]', 'resource_type': 'api', 'url_type': 'api'}, {'name': 'Philippines - Subnational Administrative Boundaries', 'description': 'Philippines - Subnational Administrative Boundaries', 'url': 'https://gistmaps.itos.uga.edu/arcgis/rest/services/V00_0/PHL_pcode/MapServer', 'format': 'LIVE SERVICE', 'grouping': '1', 'daterange_for_data': '[2020-07-30T09:59:36 TO 1900-01-01T00:00:00]', 'resource_type': 'api', 'url_type': 'api'}, {'name': 'Philippines - Subnational Administrative Boundaries', 'description': 'Philippines - Subnational Administrative Boundaries', 'url': 'https://data.humdata.org/dataset/caf116df-f984-4deb-85ca-41b349d3f313/resource/7c56c053-00f9-4eb7-ad61-6d07a954fc2b/download/phl-cod-ab-2020_06_05.pdf', 'format': 'PDF', 'grouping': 'Latest', 'daterange_for_data': '[2020-07-30T09:59:36 TO 1900-01-01T00:00:00]', 'resource_type': 'api', 'url_type': 'api'}]